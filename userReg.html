<!DOCTYPE html>
<html lang="en">
     <head>
        <title>Xi User Administration</title>
        <meta http-equiv="content-type" content="text/html; charset=UTF-8">
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">

        <link rel="stylesheet" href="vendor/css/jquery-ui.css" />
        <link rel="stylesheet" href="../xi3/css/style.css" />
        <link rel="stylesheet" href="css/userAdmin.css" />
        <link rel="stylesheet" href="css/login.css" />

        <script src="vendor/js/jquery-2.2.0.js"></script>
        <script src="vendor/js/jquery-ui.js"></script>
         
        <script src="js/dialogs.js"></script>
        <script src="js/userAdmin.js"></script>
         
         <script src="https://www.google.com/recaptcha/api.js"></script>
     </head>
    
     <body>
         
        <header>
            <h1>Xi New User Registration</h1>
        </header>
         
        <h4>Hotmail/Yahoo/Gmail addresses not allowed. Passwords must be at least 6 characters long.</h4>

        <div class="login">

              <form id="login_form" name="login_form" method="post" action="./php/newUser2.php" class="login-form">
                <div class="control-group">
                    <label for="email">Email Address</label>
                    <input type="email" value="" placeholder="email@address" id="email" name="email" pattern="\b[\w\.-]+@((?!gmail|googlemail|yahoo|hotmail).)[\w\.-]+\.\w{2,4}\b"  required/>
                    <span class="error">&lt; Hotmail/Yahoo/Gmail addresses not supported</span>
                </div>
                  <!-- oninvalid="this.setCustomValidity('Hotmail/Yahoo/Gmail addresses not supported')" -->

                <div class="control-group">
                    <label for="pass1">Password</label>
                    <input type="password" value="" placeholder="Password" id="pass1" name="pass1" pattern=".{6,}" oninput="this.setCustomValidity('')" oninvalid="this.setCustomValidity('At least 6 characters required')" required/>
                    <!-- oninvalid="this.setCustomValidity('At least 6 characters required')"S -->
                    <span class="error">&lt; Passwords don't match</span>
                </div>
                  
                <div class="control-group">
                  <label for="pass2">Repeat Password</label>
                  <input type="password" value="" placeholder="Repeat Password" id="pass2" name="pass2" pattern=".{6,}" oninput="this.setCustomValidity('')" oninvalid="this.setCustomValidity('At least 6 characters required')" required/>
                  <span class="error">&lt; Passwords don't match</span>
                </div>
                  
                <div class="g-recaptcha" id="recaptchaWidget" data-sitekey="6Le0WQwUAAAAAHc-iZVLcvIiFHNTdIH-btjCx4F2"></div>
                <span class="error">&lt; Please check the captcha form</span>

                <input name="Submit" value="Login" type="submit" class="btn btn-1a"/>

              </form>
            
            <div id="msg"></div>

            <script type="text/javascript"> 
                // divert form submit action to this javascript function
                $("#login_form").submit (function(e) {
                    console.log ("captcha", grecaptcha.getResponse());
                    console.log ("e", e);
                    if ($("#pass1").prop("value") === $("#pass2").prop("value")) {
                        ajaxPost (e.target);
                    } else {
                        $("#pass1").siblings(".error").css("display", "inline");
                    }
                    e.preventDefault();
                });

                // when input is changed cancel the display of previous error messages
                $("input[type='text'],input[type='password']").on("input", function() {
                    $(".error").css("display", null);
                });

                function ajaxPost (formElement) {
                    var zform = $(formElement);
                    // grab form input field values and put them in a json obj
                    var json = {redirect: document.referrer, "g-recaptcha-response": grecaptcha.getResponse()};
                    console.log ("redirect", document.referrer, formElement);
                    zform.find("input[type='text'],input[type='email'],input[type='password']").each (function() { 
                        var elem = $(this);
                        console.log ("elem", elem, elem.attr("name"), elem.prop("value"));
                        json[elem.attr("name")] = elem.prop("value");
                    });

                    $.ajax ({
                        type: zform.attr("method"),
                        url: zform.attr("action"),
                        data: json,
                        dataType: "json",
                        encode: true,
                        success: function (data, status, xhr) {
                            if (data.status === "success") {
                                if (data.redirect) {    // redirect if login good
                                    window.location.assign (data.redirect);
                                } else if (data.msg) {
                                    $("#msg").text(data.msg);
                                }         
                            }
                            else if (data.status === "fail") {
                                if (data.field) {    // say which field is wrong if login bad
                                    $("#"+data.field).siblings(".error").css("display", "inline");
                                } else if (data.msg) {
                                     $("#msg").text(data.msg);
                                }
                            }
                        },
                        error: function (jqXhr, textStatus, errorThrown) {
                            console.log ("error args", arguments); // some other error chucked by php
                        }
                    });       
                }
            </script>
        </div>

        <footer>
            <p>Â© Rappsilber Laboratory, 2016</p>
        </footer>

    </body>
</html>